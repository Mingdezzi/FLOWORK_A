<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOWORK - ì„¤ì •</title>
    
    <link rel="icon" href="{{ url_for('static', filename='symbol.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/journal/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
</head>
<body data-api-stores-url="{{ url_for('api.get_stores') }}"
      data-api-stores-add-url="{{ url_for('api.add_store') }}"
      data-api-store-update-url-prefix="{{ url_for('api.update_store', store_id=0)[:-1] }}"
      data-api-store-delete-url-prefix="{{ url_for('api.delete_store', store_id=0)[:-1] }}"
      data-api-brand-name-set-url="{{ url_for('api.update_brand_name') }}"
      data-api-load-settings-url="{{ url_for('api.load_settings_from_file') }}"
      data-api-setting-url="{{ url_for('api.update_setting') }}"
      
      data-api-staff-add-url="{{ url_for('api.add_staff') }}"
      data-api-staff-update-url-prefix="{{ url_for('api.update_staff', staff_id=0)[:-1] }}"
      data-api-staff-delete-url-prefix="{{ url_for('api.delete_staff', staff_id=0)[:-1] }}"
      
      data-api-store-approve-url-prefix="{{ url_for('api.approve_store', store_id=0)[:-1] }}"
      data-api-store-toggle-active-url-prefix="{{ url_for('api.toggle_store_active', store_id=0)[:-1] }}"
      data-api-store-reset-url-prefix="{{ url_for('api.reset_store_registration', store_id=0)[:-1] }}"
      
      data-analyze-excel-url="{{ url_for('api.analyze_excel') }}">
    
    <div class="container my-4">
        
        {% include '_header.html' %}

        {% include '_navigation.html' %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert {{ 'alert-success' if category == 'success' else ('alert-info' if category == 'info' else ('alert-warning' if category == 'warning' else 'alert-danger')) }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}


        <hr class="my-4">
        <div class="mb-4">
            <h2 class="section-title"><i class="bi bi-gear-fill me-2"></i>ì„¤ì •</h2>

            {% if current_user.brand_id and not current_user.store_id %}
            
            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-patch-check-fill me-2"></i>ë¸Œëœë“œ ì´ë¦„ ì„¤ì •</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ë¸Œëœë“œ(ìƒí˜¸ëª…)ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</strong>
                        <span>ì´ ì´ë¦„ì€ SMS ë°œì†¡ ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤. (ì˜ˆ: FLOWORK)</span>
                    </div>
                    <form class="input-group" id="form-brand-name">
                        <input type="text" class="form-control" placeholder="ì˜ˆ: FLOWORK" id="brand-name-input" value="{{ brand_name or '' }}" required>
                        <button class="btn btn-primary" type="submit" id="btn-save-brand-name">
                            <i class="bi bi-save-fill me-1"></i> ë¸Œëœë“œ ì´ë¦„ ì €ì¥
                        </button>
                    </form>
                    <div id="brand-name-status" class="mt-2"></div>
                </div>
            </div>

            <div class="card mb-3 management-section border-info">
                <div class="card-header bg-info text-dark">
                    <h3 class="mb-0"><i class="bi bi-file-earmark-code-fill me-2"></i>ë¸Œëœë“œ ì„¤ì • íŒŒì¼ ë¡œë“œ</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ì„œë²„ì— ì €ì¥ëœ ì„¤ì • íŒŒì¼(JSON)ì„ ë¶ˆëŸ¬ì™€ DBì— ì ìš©í•©ë‹ˆë‹¤.</strong>
                        <span><code>flowork/brands/{{ current_user.brand.brand_name }}.json</code> íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.<br>
                        (ë°”ì½”ë“œ ê·œì¹™, ì‚¬ì´ì¦ˆ ì •ë ¬ ìˆœì„œ, í—ˆìš© ì¹´í…Œê³ ë¦¬ ë“±)</span>
                    </div>
                    <button class="btn btn-info" type="button" id="btn-load-settings">
                        <i class="bi bi-cloud-upload-fill me-1"></i> ì„¤ì • íŒŒì¼ ë¡œë“œ ë° ì ìš©
                    </button>
                    <div id="load-settings-status" class="mt-2"></div>
                </div>
            </div>

            <div class="card mb-3 management-section border-primary">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-grid-fill me-2"></i>ê²€ìƒ‰ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì„¤ì •</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>(ì°¸ê³ ) í˜„ì¬ëŠ” DBì˜ 'í’ˆëª©' ì •ë³´ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë²„íŠ¼ì´ ìƒì„±ë©ë‹ˆë‹¤.</strong>
                        <span>ì•„ë˜ ì„¤ì •ì€ ìˆ˜ë™ ëª¨ë“œì¼ ë•Œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
                    </div>
                    
                    <form id="form-category-config">
                        <div class="mb-3">
                            <label for="cat-columns" class="form-label fw-bold">í•œ ì¤„ì— í‘œì‹œí•  ë²„íŠ¼ ìˆ˜ (ì—´ ê°œìˆ˜)</label>
                            <select id="cat-columns" class="form-select" style="max-width: 200px;">
                                <option value="2">2ê°œ (2ì—´)</option>
                                <option value="3">3ê°œ (3ì—´)</option>
                                <option value="4" selected>4ê°œ (4ì—´ - ê¸°ë³¸)</option>
                                <option value="5">5ê°œ (5ì—´)</option>
                                <option value="6">6ê°œ (6ì—´)</option>
                                <option value="8">8ê°œ (8ì—´)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ë²„íŠ¼ ëª©ë¡ êµ¬ì„±</label>
                            <div id="cat-buttons-container">
                                </div>
                            <button type="button" class="btn btn-sm btn-outline-success mt-2" id="btn-add-cat-row">
                                <i class="bi bi-plus-lg"></i> ë²„íŠ¼ ì¶”ê°€
                            </button>
                        </div>

                        <button type="submit" class="btn btn-primary" id="btn-save-cat-config">
                            <i class="bi bi-save-fill me-1"></i> ì„¤ì • ì €ì¥
                        </button>
                    </form>
                    <div id="category-config-status" class="mt-2"></div>
                </div>
            </div>
            {% endif %}


            {% if current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-shop me-2"></i>'ìš°ë¦¬ ë§¤ì¥' ì •ë³´</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>í˜„ì¬ ë¡œê·¸ì¸ëœ 'ìš°ë¦¬ ë§¤ì¥' ì •ë³´ì…ë‹ˆë‹¤.</strong>
                        <span>'ìš°ë¦¬ ë§¤ì¥' ì •ë³´ëŠ” 'ì „ì²´ ë§¤ì¥ ê´€ë¦¬'ì—ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                    </div>
                    {% set my_store = all_stores | selectattr('id', 'equalto', my_store_id) | first %}
                    {% if my_store %}
                    <dl class="row mb-0">
                        <dt class="col-sm-3">ë§¤ì¥ ì½”ë“œ</dt>
                        <dd class="col-sm-9">{{ my_store.store_code or '(ì—†ìŒ)' }}</dd>
                        <dt class="col-sm-3">ë§¤ì¥ ì´ë¦„</dt>
                        <dd class="col-sm-9">{{ my_store.store_name }}</dd>
                        <dt class="col-sm-3">ì—°ë½ì²˜</dt>
                        <dd class="col-sm-9">{{ my_store.phone_number or '(ì—†ìŒ)' }}</dd>
                    </dl>
                    {% else %}
                    <p class="text-danger">ì˜¤ë¥˜: í˜„ì¬ ë§¤ì¥ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                    <div id="my-store-status" class="mt-2"></div>
                </div>
            </div>
            {% endif %}

            {% if current_user.brand_id and not current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-building me-2"></i>ì „ì²´ ë§¤ì¥ ê´€ë¦¬ (ê°€ì… ìŠ¹ì¸)</h3>
                </div>
                <div class="card-body">
                    <h5 class="section-title-sub">ì‹ ê·œ ë§¤ì¥ ë“±ë¡ (ë³¸ì‚¬)</h5>
                    <form id="form-add-store" class="mb-3">
                         <div class="row g-2 mb-2 align-items-end">
                            <div class="col-md-4">
                                <label for="new_store_code" class="form-label">ë§¤ì¥ ì½”ë“œ*</label>
                                <input type="text" class="form-control" id="new_store_code" placeholder="ì˜ˆ: BS100" required>
                            </div>
                            <div class="col-md-4">
                                <label for="new_store_name" class="form-label">ë§¤ì¥ ì´ë¦„*</label>
                                <input type="text" class="form-control" id="new_store_name" placeholder="ì˜ˆ: FLOWORK ë¶€ì‚°" required>
                            </div>
                            <div class="col-md-4">
                                <label for="new_store_phone" class="form-label">ë§¤ì¥ ì—°ë½ì²˜</label>
                                <input type="tel" class="form-control" id="new_store_phone" placeholder="ì˜ˆ: 02-123-4567">
                            </div>
                        </div>
                        <button class="btn btn-success" type="submit" id="btn-add-store">
                            <i class="bi bi-plus-lg me-1"></i> ì‹ ê·œ ë§¤ì¥ ì¶”ê°€
                        </button>
                    </form>
                    <div id="add-store-status" class="mt-2 mb-3"></div>

                    <hr>
                    
                    <h5 class="section-title-sub">ì „ì²´ ë§¤ì¥ ëª©ë¡</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="all-stores-table">
                            <thead class="table-light">
                                <tr>
                                    <th>ë§¤ì¥ì½”ë“œ</th>
                                    <th>ë§¤ì¥ì´ë¦„</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>ë‹´ë‹¹ì</th>
                                    <th>ë“±ë¡ìœ ë¬´</th>
                                    <th>ìŠ¹ì¸/í™œì„±</th>
                                    <th style="width: 150px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for store in all_stores %}
                                <tr id="store-row-{{ store.id }}">
                                    <td data-field="code">{{ store.store_code or '' }}</td>
                                    <td data-field="name">{{ store.store_name }}</td>
                                    <td data-field="phone">{{ store.phone_number or '' }}</td>
                                    <td data-field="manager">{{ store.manager_name or '' }}</td>
                                    
                                    <td data-field="registered" class="text-center">
                                        {% if store.is_registered %}
                                            <span class="badge bg-success">O</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">X</span>
                                        {% endif %}
                                    </td>
                                    
                                    <td data-field="approved" class="text-center">
                                        {% if not store.is_registered %}
                                            <span class="badge bg-secondary">ë“±ë¡ëŒ€ê¸°</span>
                                        {% elif not store.is_approved %}
                                            <span class="badge bg-warning text-dark">ìŠ¹ì¸ëŒ€ê¸°</span>
                                        {% elif not store.is_active %}
                                            <span class="badge bg-danger">ë¹„í™œì„±</span>
                                        {% else %}
                                            <span class="badge bg-info">ìŠ¹ì¸(í™œì„±)</span>
                                        {% endif %}
                                    </td>
                                    
                                    <td>
                                        {% if store.is_registered and not store.is_approved %}
                                        <button class="btn btn-success btn-sm py-0 px-1 btn-approve-store"
                                                data-id="{{ store.id }}" data-name="{{ store.store_name }}"
                                                title="ê°€ì… ìŠ¹ì¸">
                                            <i class="bi bi-check-circle-fill"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-info btn-sm py-0 px-1 btn-edit-store" 
                                                data-bs-toggle="modal" data-bs-target="#edit-store-modal"
                                                data-id="{{ store.id }}"
                                                data-code="{{ store.store_code or '' }}"
                                                data-name="{{ store.store_name }}"
                                                data-phone="{{ store.phone_number or '' }}"
                                                title="ë§¤ì¥ ì •ë³´ ìˆ˜ì •">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        
                                        {% if store.is_registered %}
                                        <button class="btn btn-warning btn-sm py-0 px-1 btn-reset-store"
                                                data-id="{{ store.id }}" data-name="{{ store.store_name }}"
                                                title="ë“±ë¡ ì´ˆê¸°í™” (ë§¤ì¥ ì¬ê°€ì… í•„ìš”)">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-secondary btn-sm py-0 px-1 btn-toggle-active-store"
                                                data-id="{{ store.id }}" data-name="{{ store.store_name }}"
                                                title="{{ 'ë§¤ì¥ ë¹„í™œì„±í™”' if store.is_active else 'ë§¤ì¥ í™œì„±í™”' }}">
                                            {% if store.is_active %}
                                                <i class="bi bi-eye-slash-fill"></i>
                                            {% else %}
                                                <i class="bi bi-eye-fill"></i>
                                            {% endif %}
                                        </button>

                                        {% if not store.is_registered %}
                                        <button class="btn btn-danger btn-sm py-0 px-1 btn-delete-store"
                                                data-id="{{ store.id }}"
                                                data-name="{{ store.store_name }}"
                                                title="ë§¤ì¥ ì‚­ì œ">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr id="no-other-stores">
                                    <td colspan="7" class="text-center text-muted">ë“±ë¡ëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="delete-store-status" class="mt-2"></div>
                </div>
            </div>
            {% endif %}

            {% if current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-person-badge me-2"></i>ì§ì› ëª…ë‹¨ ê´€ë¦¬ (í˜„ì¬ ë§¤ì¥)</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>í˜„ì¬ ë§¤ì¥ì— ì†Œì†ëœ ì§ì›ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. (ìŠ¤ì¼€ì¤„ ë“±ë¡ìš©)</strong>
                        <span>(ì´ ëª…ë‹¨ì€ ë¡œê·¸ì¸ ê³„ì •ê³¼ ë³„ê°œì…ë‹ˆë‹¤.)</span>
                    </div>
                    <form id="form-add-staff" class="mb-3">
                         <div class="row g-2 mb-2 align-items-end">
                            <div class="col-md-4">
                                <label for="new_staff_name" class="form-label">ì§ì› ì´ë¦„*</label>
                                <input type="text" class="form-control" id="new_staff_name" placeholder="ì˜ˆ: í™ê¸¸ë™" required>
                            </div>
                            <div class="col-md-4">
                                <label for="new_staff_position" class="form-label">ì§ì±…</label>
                                <input type="text" class="form-control" id="new_staff_position" placeholder="ì˜ˆ: ë§¤ë‹ˆì €">
                            </div>
                            <div class="col-md-4">
                                <label for="new_staff_contact" class="form-label">ì—°ë½ì²˜</label>
                                <input type="tel" class="form-control" id="new_staff_contact" placeholder="ì˜ˆ: 010-1234-5678">
                            </div>
                        </div>
                        <button class="btn btn-success" type="submit" id="btn-add-staff">
                            <i class="bi bi-person-plus-fill me-1"></i> ì‹ ê·œ ì§ì› ì¶”ê°€
                        </button>
                    </form>
                    <div id="add-staff-status" class="mt-2 mb-3"></div>
                    <hr>
                    <h5 class="section-title-sub">ì§ì› ëª©ë¡</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="all-staff-table">
                            <thead class="table-light">
                                <tr>
                                    <th>ì§ì› ì´ë¦„</th>
                                    <th>ì§ì±…</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th style="width: 100px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in staff_list %}
                                <tr id="staff-row-{{ staff.id }}">
                                    <td data-field="name">{{ staff.name }}</td>
                                    <td data-field="position">{{ staff.position or '' }}</td>
                                    <td data-field="contact">{{ staff.contact or '' }}</td>
                                    <td>
                                        <button class="btn btn-info btn-sm py-0 px-1 btn-edit-staff" 
                                                data-bs-toggle="modal" data-bs-target="#edit-staff-modal"
                                                data-id="{{ staff.id }}"
                                                data-name="{{ staff.name }}"
                                                data-position="{{ staff.position or '' }}"
                                                data-contact="{{ staff.contact or '' }}">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm py-0 px-1 btn-delete-staff"
                                                data-id="{{ staff.id }}"
                                                data-name="{{ staff.name }}">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr id="no-staff">
                                    <td colspan="4" class="text-center text-muted">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="delete-staff-status" class="mt-2"></div>
                </div>
            </div>
            {% endif %}


            <hr class="my-4">
            <h2 class="section-title"><i class="bi bi-database-gear me-2"></i>DB ê´€ë¦¬</h2>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="dbManageTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-orders-tab" data-bs-toggle="tab" data-bs-target="#tab-orders" type="button" role="tab">1. ì£¼ë¬¸(Orders)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-announcements-tab" data-bs-toggle="tab" data-bs-target="#tab-announcements" type="button" role="tab">2. ê³µì§€ì‚¬í•­(Notice)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-products-tab" data-bs-toggle="tab" data-bs-target="#tab-products" type="button" role="tab">3. ìƒí’ˆ/ì¬ê³ (Product)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-system-tab" data-bs-toggle="tab" data-bs-target="#tab-system" type="button" role="tab">4. ì‹œìŠ¤í…œ(System)</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body tab-content" id="dbManageTabContent">
                    
                    <div class="tab-pane fade show active" id="tab-orders" role="tabpanel">
                        <h5 class="card-title mb-3">ì£¼ë¬¸ ë°ì´í„° ê´€ë¦¬</h5>
                        
                        {% if not current_user.store_id %} <div class="alert alert-info py-2 mb-3">
                            <i class="bi bi-info-circle me-2"></i>ë³¸ì‚¬ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì „ì²´ ë˜ëŠ” íŠ¹ì • ë§¤ì¥ì˜ ì£¼ë¬¸ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ëŒ€ìƒ ë§¤ì¥ ì„ íƒ</label>
                            <select class="form-select" id="orders_target_store">
                                <option value="">ì „ì²´ ë§¤ì¥ (All Stores)</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-outline-primary" onclick="downloadOrdersExcel()">
                                        <i class="bi bi-download me-2"></i>ì£¼ë¬¸ ë‚´ì—­ ë°±ì—… (ì—‘ì…€)
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_orders_excel') }}" method="POST" enctype="multipart/form-data" class="input-group" id="form-import-orders">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success">
                                        <i class="bi bi-upload"></i> ë³µêµ¬
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_orders_db') }}" method="POST" id="form-reset-orders" onsubmit="return confirmReset('ì£¼ë¬¸ ë‚´ì—­');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <button type="submit" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-trash3 me-2"></i>ì£¼ë¬¸ ë‚´ì—­ ì´ˆê¸°í™”
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-announcements" role="tabpanel">
                        <h5 class="card-title mb-3">ê³µì§€ì‚¬í•­ ë°ì´í„° ê´€ë¦¬</h5>
                        {% if not current_user.store_id %} <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <a href="{{ url_for('api.export_announcements_excel') }}" class="btn btn-outline-primary">
                                        <i class="bi bi-download me-2"></i>ê³µì§€ì‚¬í•­ ë°±ì—… (ì—‘ì…€)
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_announcements_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success">
                                        <i class="bi bi-upload"></i> ë³µêµ¬
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_announcements_db') }}" method="POST" onsubmit="return confirmReset('ê³µì§€ì‚¬í•­');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-trash3 me-2"></i>ê³µì§€ì‚¬í•­ ì´ˆê¸°í™”
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-3">ê³µì§€ì‚¬í•­ ê´€ë¦¬ëŠ” ë³¸ì‚¬ ê´€ë¦¬ì ê¶Œí•œì…ë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-products" role="tabpanel">
                        <h5 class="card-title mb-3">ìƒí’ˆ ë° ì¬ê³  ë°ì´í„° ê´€ë¦¬</h5>
                        
                        {% if not current_user.store_id %} <div class="mb-4">
                            <label class="form-label fw-bold">ëŒ€ìƒ ë§¤ì¥ ì„ íƒ (ë§¤ì¥ ì¬ê³  ê´€ë¦¬ìš©)</label>
                            <select class="form-select" id="stock_target_store">
                                <option value="">ì „ì²´ ë§¤ì¥ (All Stores)</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="row g-3 mb-4 border-bottom pb-4">
                            <div class="col-12"><h6 class="text-muted small">ë§¤ì¥ë³„ ì¬ê³  ê´€ë¦¬</h6></div>
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-outline-primary" onclick="downloadStockExcel()">
                                        <i class="bi bi-download me-2"></i>ì¬ê³  ë‚´ì—­ ë°±ì—…
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success">
                                        <i class="bi bi-upload"></i> ë³µêµ¬
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_actual_stock') }}" method="POST" onsubmit="return confirmReset('ì¬ê³  ë‚´ì—­');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <button type="submit" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-trash3 me-2"></i>ì¬ê³  ë‚´ì—­ ì´ˆê¸°í™”
                                    </button>
                                </form>
                            </div>
                        </div>

                        {% if not current_user.store_id %} <div class="row g-3">
                            <div class="col-12"><h6 class="text-muted small">ë³¸ì‚¬ DB ê´€ë¦¬ (ë¸Œëœë“œ ê³µí†µ)</h6></div>
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <a href="{{ url_for('api.export_db_excel') }}" class="btn btn-primary">
                                        <i class="bi bi-database-down me-2"></i>ë³¸ì‚¬ DB ë°±ì—…
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.inventory_upsert') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="upload_mode" value="db"/>
                                    <input type="hidden" name="is_full_import" value="true"/>
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-database-up"></i> DB ë³µêµ¬(ì´ˆê¸°í™”)
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_database_completely') }}" method="POST" onsubmit="return confirmReset('ë³¸ì‚¬ ìƒí’ˆ DB ì „ì²´');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-danger w-100">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>ë³¸ì‚¬ DB ì´ˆê¸°í™”
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-system" role="tabpanel">
                        <h5 class="card-title mb-3">ì‹œìŠ¤í…œ ê´€ë¦¬</h5>
                        
                        {% if current_user.store_id %}
                        <div class="card border-danger mb-3">
                            <div class="card-body">
                                <h6 class="text-danger">ê³„ì • ì´ˆê¸°í™” ë° ì‚­ì œ</h6>
                                <p class="small text-muted">í˜„ì¬ ë¡œê·¸ì¸ëœ ë§¤ì¥ ê³„ì •ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ê³„ì •ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
                                <form action="{{ url_for('api.delete_store', store_id=current_user.store_id) }}" method="POST" onsubmit="return confirm('ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-danger">ê³„ì • ì‚­ì œ</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if current_user.brand_id and not current_user.store_id %}
                        <div class="row g-3 mb-4">
                            <div class="col-12"><h6 class="text-muted small">ë§¤ì¥/ê³„ì • ê´€ë¦¬</h6></div>
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <a href="{{ url_for('api.export_stores_excel') }}" class="btn btn-outline-primary">
                                        <i class="bi bi-download me-2"></i>ë§¤ì¥/ê³„ì • ë°±ì—…
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_stores_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success">
                                        <i class="bi bi-upload"></i> ë³µêµ¬
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_store_db') }}" method="POST" onsubmit="return confirm('ğŸš¨ ë¸Œëœë“œ ë‚´ ëª¨ë“  ë§¤ì¥ê³¼ ê³„ì •ì´ ì‚­ì œë©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-trash3 me-2"></i>ë¸Œëœë“œ ì „ì²´ ì´ˆê¸°í™”
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if current_user.is_super_admin %}
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">ìŠˆí¼ ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥</div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <a href="{{ url_for('api.export_stores_excel') }}" class="btn btn-outline-dark w-100">ë¸Œëœë“œ ê³„ì • ë°±ì—…</a>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-dark w-100" disabled>ë¸Œëœë“œ ê³„ì • ë³µêµ¬</button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-dark w-100" disabled>ë¸Œëœë“œ ê³„ì • ì‚­ì œ</button>
                                    </div>
                                    <div class="col-md-3">
                                        <form action="{{ url_for('api.reset_store_db') }}" method="POST" onsubmit="return confirm('ğŸš¨ ëª¨ë“  ì‹œìŠ¤í…œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-danger w-100">ëª¨ë“  ì‹œìŠ¤í…œ ì´ˆê¸°í™”</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    </div>

                </div>
            </div>

        </div>

    </div>

    {% if current_user.is_admin and current_user.brand_id and not current_user.store_id %}
    <div class="modal fade" id="edit-store-modal" tabindex="-1" aria-labelledby="editStoreModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStoreModalLabel">ë§¤ì¥ ì •ë³´ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-edit-store">
                        <div class="mb-3">
                            <label for="edit_store_code" class="form-label">ë§¤ì¥ ì½”ë“œ*</label>
                            <input type="text" class="form-control" id="edit_store_code" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_store_name" class="form-label">ë§¤ì¥ ì´ë¦„*</label>
                            <input type="text" class="form-control" id="edit_store_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_store_phone" class="form-label">ë§¤ì¥ ì—°ë½ì²˜</label>
                            <input type="tel" class="form-control" id="edit_store_phone">
                        </div>
                        <div id="edit-store-status" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" id="btn-save-edit-store">ìˆ˜ì • ì™„ë£Œ</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if current_user.is_admin and current_user.store_id %}
    <div class="modal fade" id="edit-staff-modal" tabindex="-1" aria-labelledby="editStaffModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStaffModalLabel">ì§ì› ì •ë³´ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-edit-staff">
                        <div class="mb-3">
                            <label for="edit_staff_name" class="form-label">ì§ì› ì´ë¦„*</label>
                            <input type="text" class="form-control" id="edit_staff_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_staff_position" class="form-label">ì§ì±…</label>
                            <input type="text" class="form-control" id="edit_staff_position">
                        </div>
                        <div class="mb-3">
                            <label for="edit_staff_contact" class="form-label">ì—°ë½ì²˜</label>
                            <input type="tel" class="form-control" id="edit_staff_contact">
                        </div>
                        <div id="edit-staff-status" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" id="btn-save-edit-staff">ìˆ˜ì • ì™„ë£Œ</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script src="{{ url_for('static', filename='js/setting.js') }}" defer></script>
    
    <script>
        window.initialCategoryConfig = {{ category_config | tojson | safe if category_config else 'null' }};
        
        // ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ íˆë“  ì¸í’‹ ì—…ë°ì´íŠ¸ (ë³¸ì‚¬ ê´€ë¦¬ììš©)
        function updateHiddenStoreIds(selectId, inputClass) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const val = select.value;
            document.querySelectorAll('.' + inputClass).forEach(input => {
                input.value = val;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ì´ˆê¸°í™” ë° ë³€ê²½ ì´ë²¤íŠ¸ ë“±ë¡
            const ordersSelect = document.getElementById('orders_target_store');
            if(ordersSelect) {
                ordersSelect.addEventListener('change', () => updateHiddenStoreIds('orders_target_store', 'target-store-id-input'));
                updateHiddenStoreIds('orders_target_store', 'target-store-id-input'); // ì´ˆê¸°ê°’
            }

            const stockSelect = document.getElementById('stock_target_store');
            if(stockSelect) {
                stockSelect.addEventListener('change', () => updateHiddenStoreIds('stock_target_store', 'target-store-id-input'));
                updateHiddenStoreIds('stock_target_store', 'target-store-id-input'); // ì´ˆê¸°ê°’
            }

            // ê¸°ì¡´ ë¡œì§ ìœ ì§€
            const loadSettingsBtn = document.getElementById('btn-load-settings');
            const loadSettingsStatus = document.getElementById('load-settings-status');
            const loadSettingsUrl = document.body.dataset.apiLoadSettingsUrl;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (loadSettingsBtn) {
                loadSettingsBtn.addEventListener('click', async () => {
                    if (!confirm('ì„œë²„ì— ì €ì¥ëœ ë¸Œëœë“œ ì„¤ì • íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ DBì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ì„¤ì •ì´ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)')) {
                        return;
                    }
                    loadSettingsBtn.disabled = true;
                    loadSettingsStatus.innerHTML = '<div class="alert alert-info">ë¡œë”© ì¤‘...</div>';
                    try {
                        const response = await fetch(loadSettingsUrl, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrfToken }
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'ì„¤ì • ë¡œë“œ ì‹¤íŒ¨');
                        loadSettingsStatus.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        setTimeout(() => window.location.reload(), 1000);
                    } catch (error) {
                        console.error('Settings load error:', error);
                        loadSettingsStatus.innerHTML = `<div class="alert alert-danger">ì˜¤ë¥˜: ${error.message}</div>`;
                    } finally {
                        loadSettingsBtn.disabled = false;
                    }
                });
            }
        });

        function confirmReset(targetName) {
            return confirm(`ğŸš¨ ê²½ê³ : [${targetName}] ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        }

        function downloadOrdersExcel() {
            const storeId = document.getElementById('orders_target_store')?.value || '';
            // ì‹¤ì œ êµ¬í˜„ ì‹œ API ê²½ë¡œì— íŒŒë¼ë¯¸í„° ì¶”ê°€ í•„ìš”
            window.location.href = "{{ url_for('api.export_orders_excel') }}?target_store_id=" + storeId;
        }
        
        function downloadStockExcel() {
            const storeId = document.getElementById('stock_target_store')?.value || '';
             // ì‹¤ì œ êµ¬í˜„ ì‹œ API ê²½ë¡œì— íŒŒë¼ë¯¸í„° ì¶”ê°€ í•„ìš” (ì„ì‹œ ê²½ë¡œ)
            window.location.href = "{{ url_for('api.export_stock_check') }}?target_store_id=" + storeId;
        }
    </script>

</body>
</html>