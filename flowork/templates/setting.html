{% extends 'base.html' %}

{% block body_attrs %}data-api-stores-url="{{ url_for('api.get_stores') }}"
      data-api-stores-add-url="{{ url_for('api.add_store') }}"
      data-api-store-update-url-prefix="{{ url_for('api.update_store', store_id=0)[:-1] }}"
      data-api-store-delete-url-prefix="{{ url_for('api.delete_store', store_id=0)[:-1] }}"
      data-api-brand-name-set-url="{{ url_for('api.update_brand_name') }}"
      data-api-load-settings-url="{{ url_for('api.load_settings_from_file') }}"
      data-api-setting-url="{{ url_for('api.update_setting') }}"
      data-api-staff-add-url="{{ url_for('api.add_staff') }}"
      data-api-staff-update-url-prefix="{{ url_for('api.update_staff', staff_id=0)[:-1] }}"
      data-api-staff-delete-url-prefix="{{ url_for('api.delete_staff', staff_id=0)[:-1] }}"
      data-api-store-approve-url-prefix="{{ url_for('api.approve_store', store_id=0)[:-1] }}"
      data-api-store-toggle-active-url-prefix="{{ url_for('api.toggle_store_active', store_id=0)[:-1] }}"
      data-api-store-reset-url-prefix="{{ url_for('api.reset_store_registration', store_id=0)[:-1] }}"
      data-analyze-excel-url="{{ url_for('api.analyze_excel') }}"{% endblock %}

{% block content %}
<div class="container my-4">
        
        

        

        <hr class="my-4">
        <div class="mb-4">
            <h2 class="section-title"><i class="bi bi-gear-fill me-2"></i>설정</h2>
            </div>
    </div>

    {% if current_user.is_admin and not current_user.store_id %}
    <div class="modal fade" id="edit-store-modal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">매장 수정</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-edit-store"><div class="mb-3"><label>코드</label><input type="text" class="form-control" id="edit_store_code" required></div><div class="mb-3"><label>이름</label><input type="text" class="form-control" id="edit_store_name" required></div><div class="mb-3"><label>연락처</label><input type="tel" class="form-control" id="edit_store_phone"></div><div id="edit-store-status"></div></form></div><div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-store">수정 완료</button></div></div></div></div>
    {% endif %}
    
    {% if current_user.is_admin and current_user.store_id %}
    <div class="modal fade" id="edit-staff-modal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">직원 수정</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-edit-staff"><div class="mb-3"><label>이름</label><input type="text" class="form-control" id="edit_staff_name" required></div><div class="mb-3"><label>직책</label><input type="text" class="form-control" id="edit_staff_position"></div><div class="mb-3"><label>연락처</label><input type="tel" class="form-control" id="edit_staff_contact"></div><div id="edit-staff-status"></div></form></div><div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-staff">수정 완료</button></div></div></div></div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/setting.js') }}" defer></script>
<script>
        window.initialCategoryConfig = {{ category_config | tojson | safe if category_config else 'null' }};
        
        function updateHiddenInputs(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const val = select.value;
            document.querySelectorAll('.target-store-id-input').forEach(input => {
                 input.value = val;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const ordersSelect = document.getElementById('orders_target_store');
            if (ordersSelect) {
                ordersSelect.addEventListener('change', () => updateHiddenInputs('orders_target_store'));
                updateHiddenInputs('orders_target_store');
            }
            
            const stockSelect = document.getElementById('stock_target_store');
            if (stockSelect) {
                stockSelect.addEventListener('change', () => updateHiddenInputs('stock_target_store'));
                updateHiddenInputs('stock_target_store'); 
            }
        });

        function downloadOrdersExcel() {
            let storeId = '';
            const select = document.getElementById('orders_target_store');
            if (select) {
                 storeId = select.value;
            }
            window.location.href = "{{ url_for('api.export_orders_excel') }}?target_store_id=" + storeId;
        }
        
        function downloadStockExcel() {
            let storeId = '';
            const select = document.getElementById('stock_target_store');
            if (select) {
                 storeId = select.value;
            }
            window.location.href = "{{ url_for('api.export_stock_check') }}?target_store_id=" + storeId;
        }
    </script>
{% endblock %}
