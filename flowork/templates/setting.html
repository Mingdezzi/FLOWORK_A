<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOWORK - ì„¤ì •</title>
    <link rel="icon" href="{{ url_for('static', filename='symbol.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/journal/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-api-stores-url="{{ url_for('api.get_stores') }}"
      data-api-stores-add-url="{{ url_for('api.add_store') }}"
      data-api-store-update-url-prefix="{{ url_for('api.update_store', store_id=0)[:-1] }}"
      data-api-store-delete-url-prefix="{{ url_for('api.delete_store', store_id=0)[:-1] }}"
      data-api-brand-name-set-url="{{ url_for('api.update_brand_name') }}"
      data-api-load-settings-url="{{ url_for('api.load_settings_from_file') }}"
      data-api-setting-url="{{ url_for('api.update_setting') }}"
      data-api-logo-upload-url="{{ url_for('api.upload_brand_logo') }}"
      data-api-staff-add-url="{{ url_for('api.add_staff') }}"
      data-api-staff-update-url-prefix="{{ url_for('api.update_staff', staff_id=0)[:-1] }}"
      data-api-staff-delete-url-prefix="{{ url_for('api.delete_staff', staff_id=0)[:-1] }}"
      data-api-store-approve-url-prefix="{{ url_for('api.approve_store', store_id=0)[:-1] }}"
      data-api-store-toggle-active-url-prefix="{{ url_for('api.toggle_store_active', store_id=0)[:-1] }}"
      data-api-store-reset-url-prefix="{{ url_for('api.reset_store_registration', store_id=0)[:-1] }}"
      data-analyze-excel-url="{{ url_for('api.analyze_excel') }}">
    
    <div class="container my-4">
        {% include '_header.html' %}
        {% include '_navigation.html' %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert {{ 'alert-success' if category == 'success' else ('alert-info' if category == 'info' else ('alert-warning' if category == 'warning' else 'alert-danger')) }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <hr class="my-4">
        <div class="mb-4">
            <h2 class="section-title"><i class="bi bi-gear-fill me-2"></i>ì„¤ì •</h2>

            {% if not current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-patch-check-fill me-2"></i>ë¸Œëœë“œ ì„¤ì •</h3></div>
                <div class="card-body">
                    <form class="input-group mb-3" id="form-brand-name">
                        <span class="input-group-text">ë¸Œëœë“œëª…</span>
                        <input type="text" class="form-control" id="brand-name-input" value="{{ brand_name or '' }}" required>
                        <button class="btn btn-primary" type="submit" id="btn-save-brand-name">ì €ì¥</button>
                    </form>
                    <div id="brand-name-status"></div>

                    <hr>

                    <h6 class="card-subtitle mb-2 fw-bold text-dark"><i class="bi bi-image me-1"></i>ë¸Œëœë“œ ë¡œê³  ì„¤ì •</h6>
                    <form id="form-logo-upload" class="input-group mb-3" enctype="multipart/form-data">
                        <input type="file" class="form-control" id="logo-file-input" accept="image/png, image/jpeg" required>
                        <button class="btn btn-outline-primary" type="submit" id="btn-upload-logo">
                            <i class="bi bi-upload me-1"></i>ë¡œê³  ì—…ë¡œë“œ
                        </button>
                    </form>
                    <div class="form-text mb-2">
                        * ê¶Œì¥ ì‚¬ì´ì¦ˆ: ë†’ì´ 80px ì´ìƒ (íˆ¬ëª… ë°°ê²½ PNG ê¶Œì¥)<br>
                        * ì—…ë¡œë“œëœ ë¡œê³ ëŠ” ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìƒì„± ì‹œ ìƒë‹¨ì— ìë™ í•©ì„±ë©ë‹ˆë‹¤.
                    </div>
                    <div id="logo-upload-status"></div>
                    
                    <hr>
                    
                    <div class="d-flex gap-2 align-items-center justify-content-between">
                        <span class="text-muted small">ì„œë²„ì— ì €ì¥ëœ ë¸Œëœë“œ ì„¤ì • íŒŒì¼(JSON)ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</span>
                        <button class="btn btn-info btn-sm" id="btn-load-settings"><i class="bi bi-file-earmark-code"></i> ì„¤ì • íŒŒì¼ ë¡œë“œ</button>
                    </div>
                    
                    <div class="mt-2 p-2 bg-light border rounded" style="font-size: 0.85rem;">
                        {% if loaded_settings_file %}
                            <span class="text-success fw-bold">
                                <i class="bi bi-check-circle-fill me-1"></i> í˜„ì¬ ì ìš©ëœ íŒŒì¼: <strong>{{ loaded_settings_file }}</strong>
                            </span>
                        {% else %}
                            <span class="text-danger fw-bold">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i> ì ìš©ëœ ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
                            </span>
                            <br>
                            <small class="text-muted">(íŒŒì¼ ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„¤ì •ì„ ì ìš©í•˜ì„¸ìš”.)</small>
                        {% endif %}
                        
                        {% if expected_settings_file %}
                        <br>
                        <span class="text-muted">
                            (ë¡œë“œ ì‹œ `flowork/brands/{{ expected_settings_file }}` íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.)
                        </span>
                        {% endif %}
                    </div>

                    <div id="load-settings-status" class="mt-2"></div>

                    <hr>

                    <h6 class="card-subtitle mb-2 fw-bold text-dark"><i class="bi bi-grid-fill me-1"></i>ê²€ìƒ‰ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì„¤ì •</h6>
                    <form id="form-category-config">
                        <div class="mb-2">
                            <label class="form-label small mb-1">í•œ ì¤„ë‹¹ ë²„íŠ¼ ìˆ˜</label>
                            <input type="number" class="form-control form-control-sm" id="cat-columns" value="5" min="1" max="10" style="max-width: 100px;" required>
                        </div>
                        <div id="cat-buttons-container" class="mb-2">
                            </div>
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-add-cat-row">
                                <i class="bi bi-plus-lg"></i> ë²„íŠ¼ ì¶”ê°€
                            </button>
                            <button type="submit" class="btn btn-sm btn-primary" id="btn-save-cat-config">
                                <i class="bi bi-save-fill"></i> ì„¤ì • ì €ì¥
                            </button>
                        </div>
                        <div id="category-config-status"></div>
                    </form>
                </div>
            </div>

            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-building me-2"></i>ë§¤ì¥ ê´€ë¦¬</h3></div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">ì‹ ê·œ ë§¤ì¥ ë“±ë¡</h6>
                    <form id="form-add-store" class="row g-2 mb-3 align-items-end">
                        <div class="col-md-4"><input type="text" class="form-control" id="new_store_code" placeholder="ë§¤ì¥ì½”ë“œ" required></div>
                        <div class="col-md-4"><input type="text" class="form-control" id="new_store_name" placeholder="ë§¤ì¥ì´ë¦„" required></div>
                        <div class="col-md-3"><input type="tel" class="form-control" id="new_store_phone" placeholder="ì—°ë½ì²˜"></div>
                        <div class="col-md-1"><button class="btn btn-success w-100" type="submit" id="btn-add-store"><i class="bi bi-plus-lg"></i></button></div>
                    </form>
                    <div id="add-store-status" class="mb-3"></div>
                    <h6 class="card-subtitle mb-2 text-muted">ë§¤ì¥ ëª©ë¡</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="all-stores-table">
                            <thead class="table-light"><tr><th>ì½”ë“œ</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ë‹´ë‹¹ì</th><th>ìƒíƒœ</th><th>ì‘ì—…</th></tr></thead>
                            <tbody>
                                {% for store in all_stores %}
                                <tr id="store-row-{{ store.id }}">
                                    <td data-field="code">{{ store.store_code }}</td>
                                    <td data-field="name">{{ store.store_name }}</td>
                                    <td data-field="phone">{{ store.phone_number }}</td>
                                    <td data-field="manager">{{ store.manager_name }}</td>
                                    <td class="text-center">
                                        {% if not store.is_registered %}<span class="badge bg-secondary">ëŒ€ê¸°</span>
                                        {% elif not store.is_approved %}<span class="badge bg-warning text-dark">ìŠ¹ì¸ëŒ€ê¸°</span>
                                        {% elif not store.is_active %}<span class="badge bg-danger">ë¹„í™œì„±</span>
                                        {% else %}<span class="badge bg-success">ì •ìƒ</span>{% endif %}
                                    </td>
                                    <td>
                                        {% if store.is_registered and not store.is_approved %}
                                        <button class="btn btn-success btn-sm py-0 px-1 btn-approve-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="ìŠ¹ì¸"><i class="bi bi-check"></i></button>
                                        {% endif %}
                                        <button class="btn btn-info btn-sm py-0 px-1 btn-edit-store" data-bs-toggle="modal" data-bs-target="#edit-store-modal" data-id="{{ store.id }}" data-code="{{ store.store_code }}" data-name="{{ store.store_name }}" data-phone="{{ store.phone_number }}" title="ìˆ˜ì •"><i class="bi bi-pencil"></i></button>
                                        {% if store.is_registered %}
                                        <button class="btn btn-warning btn-sm py-0 px-1 btn-reset-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="ì´ˆê¸°í™”"><i class="bi bi-arrow-counterclockwise"></i></button>
                                        {% endif %}
                                        <button class="btn btn-secondary btn-sm py-0 px-1 btn-toggle-active-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="í™œì„±/ë¹„í™œì„±"><i class="bi bi-eye{{ '-slash' if store.is_active else '' }}"></i></button>
                                        {% if not store.is_registered %}
                                        <button class="btn btn-danger btn-sm py-0 px-1 btn-delete-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="ì‚­ì œ"><i class="bi bi-trash"></i></button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="delete-store-status"></div>
                </div>
            </div>
            {% endif %}

            {% if current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-shop me-2"></i>ë§¤ì¥ ì •ë³´</h3></div>
                <div class="card-body">
                    {% set my_store = all_stores | selectattr('id', 'equalto', my_store_id) | first %}
                    <dl class="row mb-0">
                        <dt class="col-sm-2">ë§¤ì¥ëª…</dt><dd class="col-sm-4">{{ my_store.store_name if my_store else '' }}</dd>
                        <dt class="col-sm-2">ì½”ë“œ</dt><dd class="col-sm-4">{{ my_store.store_code if my_store else '' }}</dd>
                    </dl>
                </div>
            </div>
            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-person-badge me-2"></i>ì§ì› ê´€ë¦¬</h3></div>
                <div class="card-body">
                    <form id="form-add-staff" class="row g-2 mb-3 align-items-end">
                        <div class="col-md-4"><input type="text" class="form-control" id="new_staff_name" placeholder="ì´ë¦„" required></div>
                        <div class="col-md-3"><input type="text" class="form-control" id="new_staff_position" placeholder="ì§ì±…"></div>
                        <div class="col-md-4"><input type="tel" class="form-control" id="new_staff_contact" placeholder="ì—°ë½ì²˜"></div>
                        <div class="col-md-1"><button class="btn btn-success w-100" type="submit" id="btn-add-staff"><i class="bi bi-plus-lg"></i></button></div>
                    </form>
                    <div id="add-staff-status"></div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="all-staff-table">
                            <thead><tr><th>ì´ë¦„</th><th>ì§ì±…</th><th>ì—°ë½ì²˜</th><th>ì‘ì—…</th></tr></thead>
                            <tbody>
                                {% for staff in staff_list %}
                                <tr id="staff-row-{{ staff.id }}">
                                    <td data-field="name">{{ staff.name }}</td>
                                    <td data-field="position">{{ staff.position }}</td>
                                    <td data-field="contact">{{ staff.contact }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info btn-edit-staff" data-bs-toggle="modal" data-bs-target="#edit-staff-modal" data-id="{{ staff.id }}" data-name="{{ staff.name }}" data-position="{{ staff.position }}" data-contact="{{ staff.contact }}"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-sm btn-danger btn-delete-staff" data-id="{{ staff.id }}" data-name="{{ staff.name }}"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="delete-staff-status"></div>
                </div>
            </div>
            {% endif %}

            <hr class="my-4">
            <h2 class="section-title"><i class="bi bi-database-gear me-2"></i>DB ê´€ë¦¬</h2>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="dbManageTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-orders-tab" data-bs-toggle="tab" data-bs-target="#tab-orders" type="button">1. ì£¼ë¬¸(Orders)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-announcements-tab" data-bs-toggle="tab" data-bs-target="#tab-announcements" type="button">2. ê³µì§€ì‚¬í•­(Notice)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-products-tab" data-bs-toggle="tab" data-bs-target="#tab-products" type="button">3. ìƒí’ˆ/ì¬ê³ (Product)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-system-tab" data-bs-toggle="tab" data-bs-target="#tab-system" type="button">4. ì‹œìŠ¤í…œ(System)</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-orders">
                        
                        {% if current_user.store_id %}
                        <h5 class="card-title text-primary">[ë§¤ì¥ ê´€ë¦¬ì] ì£¼ë¬¸ ë°ì´í„° ê´€ë¦¬</h5>
                        <div class="alert alert-light border">ë³¸ì¸ ë§¤ì¥ì˜ ì£¼ë¬¸ ë‚´ì—­ë§Œ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_orders_excel') }}?target_store_id={{ current_user.store_id }}" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-download me-2"></i>(1-1) ì£¼ë¬¸ ë‚´ì—­ ë°±ì—…
                                </a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_orders_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (1-2) ë³µêµ¬</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_orders_db') }}" method="POST" onsubmit="return confirm('âš ï¸ ë³¸ì¸ ë§¤ì¥ì˜ ëª¨ë“  ì£¼ë¬¸ ë‚´ì—­ì´ ì‚­ì œë©ë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(1-3) ì´ˆê¸°í™”</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[ë³¸ì‚¬ ê´€ë¦¬ì] ì£¼ë¬¸ ë°ì´í„° ê´€ë¦¬</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ëŒ€ìƒ ë§¤ì¥ ì„ íƒ</label>
                            <select class="form-select" id="orders_target_store">
                                <option value="">ì „ì²´ ë§¤ì¥ (All Stores)</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="downloadOrdersExcel()">
                                    <i class="bi bi-download me-2"></i>(1-1) ì£¼ë¬¸ ë‚´ì—­ ë°±ì—…
                                </button>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_orders_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (1-2) ë³µêµ¬</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_orders_db') }}" method="POST" onsubmit="return confirm('âš ï¸ ì„ íƒëœ ë§¤ì¥ì˜ ì£¼ë¬¸ ë‚´ì—­ì´ ì‚­ì œë©ë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(1-3) ì´ˆê¸°í™”</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-announcements">
                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[ë³¸ì‚¬ ê´€ë¦¬ì] ê³µì§€ì‚¬í•­ ê´€ë¦¬</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_announcements_excel') }}" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-download me-2"></i>(2-1) ê³µì§€ì‚¬í•­ ë°±ì—…
                                </a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_announcements_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (2-2) ë³µêµ¬</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_announcements_db') }}" method="POST" onsubmit="return confirm('âš ï¸ ëª¨ë“  ê³µì§€ì‚¬í•­ì´ ì‚­ì œë©ë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(2-3) ì´ˆê¸°í™”</button>
                                </form>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-5">ê³µì§€ì‚¬í•­ ë°ì´í„° ê´€ë¦¬ëŠ” ë³¸ì‚¬ ê´€ë¦¬ì ì „ìš©ì…ë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-products">
                        
                        {% if current_user.store_id %}
                        <h5 class="card-title text-primary">[ë§¤ì¥ ê´€ë¦¬ì] ìƒí’ˆ/ì¬ê³  ê´€ë¦¬</h5>
                        <div class="alert alert-light border">ë³¸ì¸ ë§¤ì¥ì˜ ì¬ê³  ë°ì´í„°ë§Œ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_stock_check') }}?target_store_id={{ current_user.store_id }}" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-download me-2"></i>(3-1) ì¬ê³  ë°±ì—…
                                </a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (3-2) ë³µêµ¬</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_actual_stock') }}" method="POST" onsubmit="return confirm('âš ï¸ ë³¸ì¸ ë§¤ì¥ì˜ ì¬ê³ ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(3-3) ì´ˆê¸°í™”</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[ë³¸ì‚¬ ê´€ë¦¬ì] ìƒí’ˆ/ì¬ê³  ê´€ë¦¬</h5>
                        
                        <h6 class="text-muted mt-3 border-bottom pb-2">ë§¤ì¥ë³„ ì¬ê³  ê´€ë¦¬</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ëŒ€ìƒ ë§¤ì¥ ì„ íƒ</label>
                            <select class="form-select" id="stock_target_store">
                                <option value="">ì „ì²´ ë§¤ì¥ (All Stores)</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="downloadStockExcel()">
                                    <i class="bi bi-download me-2"></i>(3-1) ì¬ê³  ë°±ì—…
                                </button>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (3-2) ë³µêµ¬</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_actual_stock') }}" method="POST" onsubmit="return confirm('âš ï¸ ì„ íƒ ë§¤ì¥ì˜ ì¬ê³ ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(3-3) ì´ˆê¸°í™”</button>
                                </form>
                            </div>
                        </div>

                        <h6 class="text-muted mt-3 border-bottom pb-2">ë³¸ì‚¬ DB ê´€ë¦¬ (ë¸Œëœë“œ ê³µí†µ)</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <a href="{{ url_for('api.export_db_excel') }}" class="btn btn-primary w-100"><i class="bi bi-database-down me-2"></i>(3-4) ë³¸ì‚¬ DB ë°±ì—…</a>
                            </div>
                            <div class="col-md-6">
                                <form action="{{ url_for('api.inventory_upsert') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="upload_mode" value="db">
                                    <input type="hidden" name="is_full_import" value="true">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-success"><i class="bi bi-database-up"></i> (3-5) ë³µêµ¬</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-system">
                        
                        {% if current_user.store_id %}
                        <h5 class="card-title text-primary">[ë§¤ì¥ ê´€ë¦¬ì] ì‹œìŠ¤í…œ ê´€ë¦¬</h5>
                        <div class="card border-danger mb-3">
                            <div class="card-body">
                                <h6 class="text-danger">(4-1) ê³„ì • ì´ˆê¸°í™” ë° ì‚­ì œ</h6>
                                <p class="small text-muted">í˜„ì¬ ë¡œê·¸ì¸ëœ ë§¤ì¥ ê³„ì •ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  íƒˆí‡´í•©ë‹ˆë‹¤.</p>
                                <form action="{{ url_for('api.delete_store', store_id=current_user.store_id) }}" method="POST" onsubmit="return confirm('ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger">ê³„ì • ì‚­ì œ</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[ë³¸ì‚¬ ê´€ë¦¬ì] ì‹œìŠ¤í…œ ê´€ë¦¬</h5>
                        <h6 class="text-muted mt-3 border-bottom pb-2">ë§¤ì¥/ê³„ì • ê´€ë¦¬</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_stores_excel') }}" class="btn btn-outline-primary w-100"><i class="bi bi-download me-2"></i>(4-1) ë§¤ì¥/ê³„ì • ë°±ì—…</a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_stores_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (4-2) ë³µêµ¬</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_store_db') }}" method="POST" onsubmit="return confirm('ğŸš¨ ë¸Œëœë“œ ë‚´ ëª¨ë“  ë§¤ì¥ê³¼ ê³„ì •ì´ ì‚­ì œë©ë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(4-3) ë¸Œëœë“œ ì „ì²´ ì´ˆê¸°í™”</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if current_user.is_super_admin %}
                        <div class="card border-danger mt-4">
                            <div class="card-header bg-danger text-white">[ìŠˆí¼ ê´€ë¦¬ì] ì „ìš© ê¸°ëŠ¥</div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <a href="{{ url_for('api.export_stores_excel') }}" class="btn btn-outline-dark w-100">(4-1) ë¸Œëœë“œ ê³„ì • ë°±ì—…</a>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-dark w-100" disabled>(4-2) ë¸Œëœë“œ ê³„ì • ë³µêµ¬ (êµ¬í˜„ì¤‘)</button>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-dark w-100" disabled>(4-3) ë¸Œëœë“œ ê³„ì • ì‚­ì œ (êµ¬í˜„ì¤‘)</button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-dark w-100" disabled>(4-4) ë¸Œëœë“œ ê³„ì • ë¹„í™œì„±í™” (êµ¬í˜„ì¤‘)</button>
                                    </div>
                                    <div class="col-md-6">
                                        <form action="{{ url_for('api.reset_store_db') }}" method="POST" onsubmit="return confirm('ğŸš¨ ëª¨ë“  ì‹œìŠ¤í…œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-danger w-100">(4-5) ëª¨ë“  ì‹œìŠ¤í…œ ì´ˆê¸°í™”</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>

    {% if current_user.is_admin and not current_user.store_id %}
    <div class="modal fade" id="edit-store-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ë§¤ì¥ ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-edit-store">
                        <div class="mb-3"><label>ì½”ë“œ</label><input type="text" class="form-control" id="edit_store_code" required></div>
                        <div class="mb-3"><label>ì´ë¦„</label><input type="text" class="form-control" id="edit_store_name" required></div>
                        <div class="mb-3"><label>ì—°ë½ì²˜</label><input type="tel" class="form-control" id="edit_store_phone"></div>
                        <div id="edit-store-status"></div>
                    </form>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-store">ìˆ˜ì • ì™„ë£Œ</button></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if current_user.is_admin and current_user.store_id %}
    <div class="modal fade" id="edit-staff-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ì§ì› ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-edit-staff">
                        <div class="mb-3"><label>ì´ë¦„</label><input type="text" class="form-control" id="edit_staff_name" required></div>
                        <div class="mb-3"><label>ì§ì±…</label><input type="text" class="form-control" id="edit_staff_position"></div>
                        <div class="mb-3"><label>ì—°ë½ì²˜</label><input type="tel" class="form-control" id="edit_staff_contact"></div>
                        <div id="edit-staff-status"></div>
                    </form>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-staff">ìˆ˜ì • ì™„ë£Œ</button></div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/setting.js') }}" defer></script>
    
    <script>
        window.initialCategoryConfig = {{ category_config | tojson | safe if category_config else 'null' }};
        
        function updateHiddenInputs(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const val = select.value;
            document.querySelectorAll('.target-store-id-input').forEach(input => {
                 input.value = val;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const ordersSelect = document.getElementById('orders_target_store');
            if (ordersSelect) {
                ordersSelect.addEventListener('change', () => updateHiddenInputs('orders_target_store'));
                updateHiddenInputs('orders_target_store');
            }
            
            const stockSelect = document.getElementById('stock_target_store');
            if (stockSelect) {
                stockSelect.addEventListener('change', () => updateHiddenInputs('stock_target_store'));
                updateHiddenInputs('stock_target_store'); 
            }

            const loadSettingsBtn = document.getElementById('btn-load-settings');
            const loadSettingsStatus = document.getElementById('load-settings-status');
            const loadSettingsUrl = document.body.dataset.apiLoadSettingsUrl;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (loadSettingsBtn) {
                loadSettingsBtn.addEventListener('click', async () => {
                    if (!confirm('ë¸Œëœë“œ ì„¤ì • íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ DBì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ì„¤ì •ì´ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)')) return;
                    loadSettingsBtn.disabled = true;
                    loadSettingsStatus.innerHTML = '<div class="alert alert-info">ë¡œë”© ì¤‘...</div>';
                    try {
                        const response = await fetch(loadSettingsUrl, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrfToken }
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'ì‹¤íŒ¨');
                        loadSettingsStatus.innerHTML = `<div class="alert alert-success mt-2">${data.message}</div>`;
                        setTimeout(() => window.location.reload(), 1000);
                    } catch (error) {
                        console.error('Settings load error:', error);
                        loadSettingsStatus.innerHTML = `<div class="alert alert-danger mt-2">ì˜¤ë¥˜: ${error.message}</div>`;
                    } finally {
                        loadSettingsBtn.disabled = false;
                    }
                });
            }
        });

        function downloadOrdersExcel() {
            let storeId = '';
            const select = document.getElementById('orders_target_store');
            if (select) {
                 storeId = select.value;
            }
            window.location.href = "{{ url_for('api.export_orders_excel') }}?target_store_id=" + storeId;
        }
        
        function downloadStockExcel() {
            let storeId = '';
            const select = document.getElementById('stock_target_store');
            if (select) {
                 storeId = select.value;
            }
            window.location.href = "{{ url_for('api.export_stock_check') }}?target_store_id=" + storeId;
        }
    </script>

</body>
</html>