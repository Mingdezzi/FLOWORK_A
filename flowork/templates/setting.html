<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOWORK - ÏÑ§Ï†ï</title>
    <link rel="icon" href="{{ url_for('static', filename='symbol.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/journal/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-api-stores-url="{{ url_for('api.get_stores') }}"
      data-api-stores-add-url="{{ url_for('api.add_store') }}"
      data-api-store-update-url-prefix="{{ url_for('api.update_store', store_id=0)[:-1] }}"
      data-api-store-delete-url-prefix="{{ url_for('api.delete_store', store_id=0)[:-1] }}"
      data-api-brand-name-set-url="{{ url_for('api.update_brand_name') }}"
      data-api-load-settings-url="{{ url_for('api.load_settings_from_file') }}"
      data-api-setting-url="{{ url_for('api.update_setting') }}"
      data-api-staff-add-url="{{ url_for('api.add_staff') }}"
      data-api-staff-update-url-prefix="{{ url_for('api.update_staff', staff_id=0)[:-1] }}"
      data-api-staff-delete-url-prefix="{{ url_for('api.delete_staff', staff_id=0)[:-1] }}"
      data-api-store-approve-url-prefix="{{ url_for('api.approve_store', store_id=0)[:-1] }}"
      data-api-store-toggle-active-url-prefix="{{ url_for('api.toggle_store_active', store_id=0)[:-1] }}"
      data-api-store-reset-url-prefix="{{ url_for('api.reset_store_registration', store_id=0)[:-1] }}"
      data-analyze-excel-url="{{ url_for('api.analyze_excel') }}">
    
    <div class="container my-4">
        {% include '_header.html' %}
        {% include '_navigation.html' %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert {{ 'alert-success' if category == 'success' else ('alert-info' if category == 'info' else ('alert-warning' if category == 'warning' else 'alert-danger')) }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <hr class="my-4">
        <div class="mb-4">
            <h2 class="section-title"><i class="bi bi-gear-fill me-2"></i>ÏÑ§Ï†ï</h2>

            {% if not current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-patch-check-fill me-2"></i>Î∏åÎûúÎìú ÏÑ§Ï†ï</h3></div>
                <div class="card-body">
                    <form class="input-group mb-3" id="form-brand-name">
                        <span class="input-group-text">Î∏åÎûúÎìúÎ™Ö</span>
                        <input type="text" class="form-control" id="brand-name-input" value="{{ brand_name or '' }}" required>
                        <button class="btn btn-primary" type="submit" id="btn-save-brand-name">Ï†ÄÏû•</button>
                    </form>
                    <div id="brand-name-status"></div>
                    
                    <hr>
                    
                    <div class="d-flex gap-2 align-items-center justify-content-between">
                        <span class="text-muted small">ÏÑúÎ≤ÑÏóê Ï†ÄÏû•Îêú Î∏åÎûúÎìú ÏÑ§Ï†ï ÌååÏùº(JSON)ÏùÑ Î∂àÎü¨ÏòµÎãàÎã§.</span>
                        <button class="btn btn-info btn-sm" id="btn-load-settings"><i class="bi bi-file-earmark-code"></i> ÏÑ§Ï†ï ÌååÏùº Î°úÎìú</button>
                    </div>
                    <div id="load-settings-status" class="mt-2"></div>

                    <hr>

                    <h6 class="card-subtitle mb-2 fw-bold text-dark"><i class="bi bi-grid-fill me-1"></i>Í≤ÄÏÉâ Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÏÑ§Ï†ï</h6>
                    <form id="form-category-config">
                        <div class="mb-2">
                            <label class="form-label small mb-1">Ìïú Ï§ÑÎãπ Î≤ÑÌäº Ïàò</label>
                            <input type="number" class="form-control form-control-sm" id="cat-columns" value="5" min="1" max="10" style="max-width: 100px;" required>
                        </div>
                        <div id="cat-buttons-container" class="mb-2">
                            </div>
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-add-cat-row">
                                <i class="bi bi-plus-lg"></i> Î≤ÑÌäº Ï∂îÍ∞Ä
                            </button>
                            <button type="submit" class="btn btn-sm btn-primary" id="btn-save-cat-config">
                                <i class="bi bi-save-fill"></i> ÏÑ§Ï†ï Ï†ÄÏû•
                            </button>
                        </div>
                        <div id="category-config-status"></div>
                    </form>
                </div>
            </div>

            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-building me-2"></i>Îß§Ïû• Í¥ÄÎ¶¨</h3></div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Ïã†Í∑ú Îß§Ïû• Îì±Î°ù</h6>
                    <form id="form-add-store" class="row g-2 mb-3 align-items-end">
                        <div class="col-md-4"><input type="text" class="form-control" id="new_store_code" placeholder="Îß§Ïû•ÏΩîÎìú" required></div>
                        <div class="col-md-4"><input type="text" class="form-control" id="new_store_name" placeholder="Îß§Ïû•Ïù¥Î¶Ñ" required></div>
                        <div class="col-md-3"><input type="tel" class="form-control" id="new_store_phone" placeholder="Ïó∞ÎùΩÏ≤ò"></div>
                        <div class="col-md-1"><button class="btn btn-success w-100" type="submit" id="btn-add-store"><i class="bi bi-plus-lg"></i></button></div>
                    </form>
                    <div id="add-store-status" class="mb-3"></div>
                    <h6 class="card-subtitle mb-2 text-muted">Îß§Ïû• Î™©Î°ù</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="all-stores-table">
                            <thead class="table-light"><tr><th>ÏΩîÎìú</th><th>Ïù¥Î¶Ñ</th><th>Ïó∞ÎùΩÏ≤ò</th><th>Îã¥ÎãπÏûê</th><th>ÏÉÅÌÉú</th><th>ÏûëÏóÖ</th></tr></thead>
                            <tbody>
                                {% for store in all_stores %}
                                <tr id="store-row-{{ store.id }}">
                                    <td data-field="code">{{ store.store_code }}</td>
                                    <td data-field="name">{{ store.store_name }}</td>
                                    <td data-field="phone">{{ store.phone_number }}</td>
                                    <td data-field="manager">{{ store.manager_name }}</td>
                                    <td class="text-center">
                                        {% if not store.is_registered %}<span class="badge bg-secondary">ÎåÄÍ∏∞</span>
                                        {% elif not store.is_approved %}<span class="badge bg-warning text-dark">ÏäπÏù∏ÎåÄÍ∏∞</span>
                                        {% elif not store.is_active %}<span class="badge bg-danger">ÎπÑÌôúÏÑ±</span>
                                        {% else %}<span class="badge bg-success">Ï†ïÏÉÅ</span>{% endif %}
                                    </td>
                                    <td>
                                        {% if store.is_registered and not store.is_approved %}
                                        <button class="btn btn-success btn-sm py-0 px-1 btn-approve-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="ÏäπÏù∏"><i class="bi bi-check"></i></button>
                                        {% endif %}
                                        <button class="btn btn-info btn-sm py-0 px-1 btn-edit-store" data-bs-toggle="modal" data-bs-target="#edit-store-modal" data-id="{{ store.id }}" data-code="{{ store.store_code }}" data-name="{{ store.store_name }}" data-phone="{{ store.phone_number }}" title="ÏàòÏ†ï"><i class="bi bi-pencil"></i></button>
                                        {% if store.is_registered %}
                                        <button class="btn btn-warning btn-sm py-0 px-1 btn-reset-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="Ï¥àÍ∏∞Ìôî"><i class="bi bi-arrow-counterclockwise"></i></button>
                                        {% endif %}
                                        <button class="btn btn-secondary btn-sm py-0 px-1 btn-toggle-active-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="ÌôúÏÑ±/ÎπÑÌôúÏÑ±"><i class="bi bi-eye{{ '-slash' if store.is_active else '' }}"></i></button>
                                        {% if not store.is_registered %}
                                        <button class="btn btn-danger btn-sm py-0 px-1 btn-delete-store" data-id="{{ store.id }}" data-name="{{ store.store_name }}" title="ÏÇ≠Ï†ú"><i class="bi bi-trash"></i></button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="delete-store-status"></div>
                </div>
            </div>
            {% endif %}

            {% if current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-shop me-2"></i>Îß§Ïû• Ï†ïÎ≥¥</h3></div>
                <div class="card-body">
                    {% set my_store = all_stores | selectattr('id', 'equalto', my_store_id) | first %}
                    <dl class="row mb-0">
                        <dt class="col-sm-2">Îß§Ïû•Î™Ö</dt><dd class="col-sm-4">{{ my_store.store_name if my_store else '' }}</dd>
                        <dt class="col-sm-2">ÏΩîÎìú</dt><dd class="col-sm-4">{{ my_store.store_code if my_store else '' }}</dd>
                    </dl>
                </div>
            </div>
            <div class="card mb-3 management-section">
                <div class="card-header"><h3 class="mb-0"><i class="bi bi-person-badge me-2"></i>ÏßÅÏõê Í¥ÄÎ¶¨</h3></div>
                <div class="card-body">
                    <form id="form-add-staff" class="row g-2 mb-3 align-items-end">
                        <div class="col-md-4"><input type="text" class="form-control" id="new_staff_name" placeholder="Ïù¥Î¶Ñ" required></div>
                        <div class="col-md-3"><input type="text" class="form-control" id="new_staff_position" placeholder="ÏßÅÏ±Ö"></div>
                        <div class="col-md-4"><input type="tel" class="form-control" id="new_staff_contact" placeholder="Ïó∞ÎùΩÏ≤ò"></div>
                        <div class="col-md-1"><button class="btn btn-success w-100" type="submit" id="btn-add-staff"><i class="bi bi-plus-lg"></i></button></div>
                    </form>
                    <div id="add-staff-status"></div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="all-staff-table">
                            <thead><tr><th>Ïù¥Î¶Ñ</th><th>ÏßÅÏ±Ö</th><th>Ïó∞ÎùΩÏ≤ò</th><th>ÏûëÏóÖ</th></tr></thead>
                            <tbody>
                                {% for staff in staff_list %}
                                <tr id="staff-row-{{ staff.id }}">
                                    <td data-field="name">{{ staff.name }}</td>
                                    <td data-field="position">{{ staff.position }}</td>
                                    <td data-field="contact">{{ staff.contact }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info btn-edit-staff" data-bs-toggle="modal" data-bs-target="#edit-staff-modal" data-id="{{ staff.id }}" data-name="{{ staff.name }}" data-position="{{ staff.position }}" data-contact="{{ staff.contact }}"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-sm btn-danger btn-delete-staff" data-id="{{ staff.id }}" data-name="{{ staff.name }}"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="delete-staff-status"></div>
                </div>
            </div>
            {% endif %}

            <hr class="my-4">
            <h2 class="section-title"><i class="bi bi-database-gear me-2"></i>DB Í¥ÄÎ¶¨</h2>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="dbManageTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-orders-tab" data-bs-toggle="tab" data-bs-target="#tab-orders" type="button">1. Ï£ºÎ¨∏(Orders)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-announcements-tab" data-bs-toggle="tab" data-bs-target="#tab-announcements" type="button">2. Í≥µÏßÄÏÇ¨Ìï≠(Notice)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-products-tab" data-bs-toggle="tab" data-bs-target="#tab-products" type="button">3. ÏÉÅÌíà/Ïû¨Í≥†(Product)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-system-tab" data-bs-toggle="tab" data-bs-target="#tab-system" type="button">4. ÏãúÏä§ÌÖú(System)</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-orders">
                        
                        {% if current_user.store_id %}
                        <h5 class="card-title text-primary">[Îß§Ïû• Í¥ÄÎ¶¨Ïûê] Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h5>
                        <div class="alert alert-light border">Î≥∏Ïù∏ Îß§Ïû•Ïùò Ï£ºÎ¨∏ ÎÇ¥Ïó≠Îßå Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_orders_excel') }}?target_store_id={{ current_user.store_id }}" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-download me-2"></i>(1-1) Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î∞±ÏóÖ
                                </a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_orders_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (1-2) Î≥µÍµ¨</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_orders_db') }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è Î≥∏Ïù∏ Îß§Ïû•Ïùò Î™®Îì† Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(1-3) Ï¥àÍ∏∞Ìôî</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[Î≥∏ÏÇ¨ Í¥ÄÎ¶¨Ïûê] Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ÎåÄÏÉÅ Îß§Ïû• ÏÑ†ÌÉù</label>
                            <select class="form-select" id="orders_target_store">
                                <option value="">Ï†ÑÏ≤¥ Îß§Ïû• (All Stores)</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="downloadOrdersExcel()">
                                    <i class="bi bi-download me-2"></i>(1-1) Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î∞±ÏóÖ
                                </button>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_orders_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (1-2) Î≥µÍµ¨</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_orders_db') }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è ÏÑ†ÌÉùÎêú Îß§Ïû•Ïùò Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(1-3) Ï¥àÍ∏∞Ìôî</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-announcements">
                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[Î≥∏ÏÇ¨ Í¥ÄÎ¶¨Ïûê] Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_announcements_excel') }}" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-download me-2"></i>(2-1) Í≥µÏßÄÏÇ¨Ìï≠ Î∞±ÏóÖ
                                </a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_announcements_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (2-2) Î≥µÍµ¨</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_announcements_db') }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è Î™®Îì† Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(2-3) Ï¥àÍ∏∞Ìôî</button>
                                </form>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-5">Í≥µÏßÄÏÇ¨Ìï≠ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨Îäî Î≥∏ÏÇ¨ Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©ÏûÖÎãàÎã§.</p>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-products">
                        
                        {% if current_user.store_id %}
                        <h5 class="card-title text-primary">[Îß§Ïû• Í¥ÄÎ¶¨Ïûê] ÏÉÅÌíà/Ïû¨Í≥† Í¥ÄÎ¶¨</h5>
                        <div class="alert alert-light border">Î≥∏Ïù∏ Îß§Ïû•Ïùò Ïû¨Í≥† Îç∞Ïù¥ÌÑ∞Îßå Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_stock_check') }}?target_store_id={{ current_user.store_id }}" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-download me-2"></i>(3-1) Ïû¨Í≥† Î∞±ÏóÖ
                                </a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (3-2) Î≥µÍµ¨</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_actual_stock') }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è Î≥∏Ïù∏ Îß§Ïû•Ïùò Ïû¨Í≥†Í∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" value="{{ current_user.store_id }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(3-3) Ï¥àÍ∏∞Ìôî</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[Î≥∏ÏÇ¨ Í¥ÄÎ¶¨Ïûê] ÏÉÅÌíà/Ïû¨Í≥† Í¥ÄÎ¶¨</h5>
                        
                        <h6 class="text-muted mt-3 border-bottom pb-2">Îß§Ïû•Î≥Ñ Ïû¨Í≥† Í¥ÄÎ¶¨</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ÎåÄÏÉÅ Îß§Ïû• ÏÑ†ÌÉù</label>
                            <select class="form-select" id="stock_target_store">
                                <option value="">Ï†ÑÏ≤¥ Îß§Ïû• (All Stores)</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="downloadStockExcel()">
                                    <i class="bi bi-download me-2"></i>(3-1) Ïû¨Í≥† Î∞±ÏóÖ
                                </button>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (3-2) Î≥µÍµ¨</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_actual_stock') }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è ÏÑ†ÌÉù Îß§Ïû•Ïùò Ïû¨Í≥†Í∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(3-3) Ï¥àÍ∏∞Ìôî</button>
                                </form>
                            </div>
                        </div>

                        <h6 class="text-muted mt-3 border-bottom pb-2">Î≥∏ÏÇ¨ DB Í¥ÄÎ¶¨ (Î∏åÎûúÎìú Í≥µÌÜµ)</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_db_excel') }}" class="btn btn-primary w-100"><i class="bi bi-database-down me-2"></i>(3-4) Î≥∏ÏÇ¨ DB Î∞±ÏóÖ</a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.inventory_upsert') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="upload_mode" value="db">
                                    <input type="hidden" name="is_full_import" value="true">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-success"><i class="bi bi-database-up"></i> (3-5) Î≥µÍµ¨</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_database_completely') }}" method="POST" onsubmit="return confirm('üö® Í≤ΩÍ≥†: Î≥∏ÏÇ¨ ÏÉÅÌíà/ÏòµÏÖò DBÍ∞Ä ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger w-100"><i class="bi bi-exclamation-triangle-fill me-2"></i>(3-6) DB Ï¥àÍ∏∞Ìôî</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-system">
                        
                        {% if current_user.store_id %}
                        <h5 class="card-title text-primary">[Îß§Ïû• Í¥ÄÎ¶¨Ïûê] ÏãúÏä§ÌÖú Í¥ÄÎ¶¨</h5>
                        <div class="card border-danger mb-3">
                            <div class="card-body">
                                <h6 class="text-danger">(4-1) Í≥ÑÏ†ï Ï¥àÍ∏∞Ìôî Î∞è ÏÇ≠Ï†ú</h6>
                                <p class="small text-muted">ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Îêú Îß§Ïû• Í≥ÑÏ†ïÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÍ≥† ÌÉàÌá¥Ìï©ÎãàÎã§.</p>
                                <form action="{{ url_for('api.delete_store', store_id=current_user.store_id) }}" method="POST" onsubmit="return confirm('Ï†ïÎßêÎ°ú Í≥ÑÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger">Í≥ÑÏ†ï ÏÇ≠Ï†ú</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if not current_user.store_id %}
                        <h5 class="card-title text-success">[Î≥∏ÏÇ¨ Í¥ÄÎ¶¨Ïûê] ÏãúÏä§ÌÖú Í¥ÄÎ¶¨</h5>
                        <h6 class="text-muted mt-3 border-bottom pb-2">Îß§Ïû•/Í≥ÑÏ†ï Í¥ÄÎ¶¨</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <a href="{{ url_for('api.export_stores_excel') }}" class="btn btn-outline-primary w-100"><i class="bi bi-download me-2"></i>(4-1) Îß§Ïû•/Í≥ÑÏ†ï Î∞±ÏóÖ</a>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.import_stores_excel') }}" method="POST" enctype="multipart/form-data" class="input-group">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="file" name="excel_file" class="form-control" required>
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-upload"></i> (4-2) Î≥µÍµ¨</button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <form action="{{ url_for('api.reset_store_db') }}" method="POST" onsubmit="return confirm('üö® Î∏åÎûúÎìú ÎÇ¥ Î™®Îì† Îß§Ïû•Í≥º Í≥ÑÏ†ïÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-trash3 me-2"></i>(4-3) Î∏åÎûúÎìú Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {% if current_user.is_super_admin %}
                        <div class="card border-danger mt-4">
                            <div class="card-header bg-danger text-white">[ÏäàÌçº Í¥ÄÎ¶¨Ïûê] Ï†ÑÏö© Í∏∞Îä•</div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <a href="{{ url_for('api.export_stores_excel') }}" class="btn btn-outline-dark w-100">(4-1) Î∏åÎûúÎìú Í≥ÑÏ†ï Î∞±ÏóÖ</a>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-dark w-100" disabled>(4-2) Î∏åÎûúÎìú Í≥ÑÏ†ï Î≥µÍµ¨ (Íµ¨ÌòÑÏ§ë)</button>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-dark w-100" disabled>(4-3) Î∏åÎûúÎìú Í≥ÑÏ†ï ÏÇ≠Ï†ú (Íµ¨ÌòÑÏ§ë)</button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-dark w-100" disabled>(4-4) Î∏åÎûúÎìú Í≥ÑÏ†ï ÎπÑÌôúÏÑ±Ìôî (Íµ¨ÌòÑÏ§ë)</button>
                                    </div>
                                    <div class="col-md-6">
                                        <form action="{{ url_for('api.reset_store_db') }}" method="POST" onsubmit="return confirm('üö® Î™®Îì† ÏãúÏä§ÌÖú Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-danger w-100">(4-5) Î™®Îì† ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>

    {% if current_user.is_admin and not current_user.store_id %}
    <div class="modal fade" id="edit-store-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Îß§Ïû• ÏàòÏ†ï</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-edit-store">
                        <div class="mb-3"><label>ÏΩîÎìú</label><input type="text" class="form-control" id="edit_store_code" required></div>
                        <div class="mb-3"><label>Ïù¥Î¶Ñ</label><input type="text" class="form-control" id="edit_store_name" required></div>
                        <div class="mb-3"><label>Ïó∞ÎùΩÏ≤ò</label><input type="tel" class="form-control" id="edit_store_phone"></div>
                        <div id="edit-store-status"></div>
                    </form>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-store">ÏàòÏ†ï ÏôÑÎ£å</button></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if current_user.is_admin and current_user.store_id %}
    <div class="modal fade" id="edit-staff-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ÏßÅÏõê ÏàòÏ†ï</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-edit-staff">
                        <div class="mb-3"><label>Ïù¥Î¶Ñ</label><input type="text" class="form-control" id="edit_staff_name" required></div>
                        <div class="mb-3"><label>ÏßÅÏ±Ö</label><input type="text" class="form-control" id="edit_staff_position"></div>
                        <div class="mb-3"><label>Ïó∞ÎùΩÏ≤ò</label><input type="tel" class="form-control" id="edit_staff_contact"></div>
                        <div id="edit-staff-status"></div>
                    </form>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-staff">ÏàòÏ†ï ÏôÑÎ£å</button></div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/setting.js') }}" defer></script>
    
    <script>
        window.initialCategoryConfig = {{ category_config | tojson | safe if category_config else 'null' }};
        
        // ÎìúÎ°≠Îã§Ïö¥ Í∞í Î≥ÄÍ≤Ω Ïãú hidden input ÏóÖÎç∞Ïù¥Ìä∏ (Î≥∏ÏÇ¨ Í¥ÄÎ¶¨ÏûêÏö©)
        function updateHiddenInputs(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const val = select.value;
            document.querySelectorAll('.target-store-id-input').forEach(input => {
                 input.value = val;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Ï£ºÎ¨∏ ÌÉ≠ ÎìúÎ°≠Îã§Ïö¥
            const ordersSelect = document.getElementById('orders_target_store');
            if (ordersSelect) {
                ordersSelect.addEventListener('change', () => updateHiddenInputs('orders_target_store'));
                updateHiddenInputs('orders_target_store'); // Ï¥àÍ∏∞Í∞í Î∞òÏòÅ
            }
            
            // Ïû¨Í≥† ÌÉ≠ ÎìúÎ°≠Îã§Ïö¥
            const stockSelect = document.getElementById('stock_target_store');
            if (stockSelect) {
                stockSelect.addEventListener('change', () => updateHiddenInputs('stock_target_store'));
                updateHiddenInputs('stock_target_store'); // Ï¥àÍ∏∞Í∞í Î∞òÏòÅ
            }

            // ÏÑ§Ï†ï ÌååÏùº Î°úÎìú Î°úÏßÅ
            const loadSettingsBtn = document.getElementById('btn-load-settings');
            const loadSettingsStatus = document.getElementById('load-settings-status');
            const loadSettingsUrl = document.body.dataset.apiLoadSettingsUrl;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (loadSettingsBtn) {
                loadSettingsBtn.addEventListener('click', async () => {
                    if (!confirm('Î∏åÎûúÎìú ÏÑ§Ï†ï ÌååÏùºÏùÑ Î°úÎìúÌïòÏó¨ DBÏóê Ï†ÅÏö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Í∏∞Ï°¥ ÏÑ§Ï†ïÏù¥ ÎçÆÏñ¥ÏîåÏõåÏßà Ïàò ÏûàÏäµÎãàÎã§.)')) return;
                    loadSettingsBtn.disabled = true;
                    loadSettingsStatus.innerHTML = '<div class="alert alert-info">Î°úÎî© Ï§ë...</div>';
                    try {
                        const response = await fetch(loadSettingsUrl, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrfToken }
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'Ïã§Ìå®');
                        loadSettingsStatus.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        setTimeout(() => window.location.reload(), 1000);
                    } catch (error) {
                        console.error('Settings load error:', error);
                        loadSettingsStatus.innerHTML = `<div class="alert alert-danger">Ïò§Î•ò: ${error.message}</div>`;
                    } finally {
                        loadSettingsBtn.disabled = false;
                    }
                });
            }
        });

        function downloadOrdersExcel() {
            let storeId = '';
            const select = document.getElementById('orders_target_store');
            if (select) {
                 storeId = select.value;
            }
            window.location.href = "{{ url_for('api.export_orders_excel') }}?target_store_id=" + storeId;
        }
        
        function downloadStockExcel() {
            let storeId = '';
            const select = document.getElementById('stock_target_store');
            if (select) {
                 storeId = select.value;
            }
            window.location.href = "{{ url_for('api.export_stock_check') }}?target_store_id=" + storeId;
        }
    </script>

</body>
</html>