{% extends 'base.html' %}

{% block body_attrs %}
data-update-status-url="{{ url_for('api.api_update_order_status') }}"
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="card mb-4 rounded-0 border shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-clock-history me-2"></i>진행 중인 주문 ({{ pending_orders|length }}건)</h5>
            <a href="{{ url_for('ui.new_order') }}" class="btn btn-primary btn-sm rounded-0">
                <i class="bi bi-plus-lg me-1"></i> 신규 주문 등록
            </a>
        </div>
        <div class="card-body p-0">
            <ul class="list-group list-group-flush" id="pending-order-list">
                {% for order in pending_orders %}
                <li class="list-group-item p-3 border-bottom">
                    <div class="row align-items-center mb-3 cursor-pointer" onclick="window.location='{{ url_for('ui.order_detail', order_id=order.id) }}';" style="cursor: pointer;">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-light text-dark border rounded-0 me-2">{{ order.created_at.strftime('%Y-%m-%d') }}</span>
                                <strong class="fs-5 text-dark me-2">{{ order.customer_name }}</strong>
                                <small class="text-muted">{{ order.customer_phone }}</small>
                            </div>
                            <div class="text-muted small">
                                <span class="fw-bold text-dark">{{ order.product_name }}</span> 
                                <span class="mx-1 text-secondary">|</span> {{ order.product_number }}
                                <span class="mx-1 text-secondary">|</span> {{ order.color }} / {{ order.size }}
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-2 mt-md-0">
                            <div class="d-flex justify-content-end gap-2" onclick="event.stopPropagation();">
                                <a href="tel:{{ order.customer_phone.replace('-', '') }}" class="btn btn-outline-success btn-sm rounded-0 px-3" title="전화걸기">
                                    <i class="bi bi-telephone-fill"></i>
                                </a>
                                <a href="{{ order.sms_link }}" class="btn btn-outline-primary btn-sm rounded-0 px-3" title="문자보내기">
                                    <i class="bi bi-chat-dots-fill"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-status-grid">
                        <div class="d-flex flex-wrap gap-1">
                            <button type="button" class="btn btn-sm rounded-0 flex-grow-1 status-btn {{ 'btn-primary' if order.order_status == '고객주문' else 'btn-outline-secondary' }}" data-order-id="{{ order.id }}" data-new-status="고객주문">고객주문</button>
                            <button type="button" class="btn btn-sm rounded-0 flex-grow-1 status-btn {{ 'btn-primary' if order.order_status == '주문등록' else 'btn-outline-secondary' }}" data-order-id="{{ order.id }}" data-new-status="주문등록">주문등록</button>
                            <button type="button" class="btn btn-sm rounded-0 flex-grow-1 status-btn {{ 'btn-primary' if order.order_status == '매장도착' else 'btn-outline-secondary' }}" data-order-id="{{ order.id }}" data-new-status="매장도착">매장도착</button>
                            
                            {% if order.reception_method == '택배수령' %}
                            <button type="button" class="btn btn-sm rounded-0 flex-grow-1 status-btn {{ 'btn-primary' if order.order_status == '택배 발송' else 'btn-outline-secondary' }}" data-order-id="{{ order.id }}" data-new-status="택배 발송">택배 발송</button>
                            {% else %}
                            <button type="button" class="btn btn-sm rounded-0 flex-grow-1 status-btn {{ 'btn-primary' if order.order_status == '고객연락' else 'btn-outline-secondary' }}" data-order-id="{{ order.id }}" data-new-status="고객연락">고객연락</button>
                            {% endif %}
                            
                            <button type="button" class="btn btn-sm rounded-0 flex-grow-1 status-btn {{ 'btn-dark' if order.order_status == '완료' else 'btn-outline-dark' }}" data-order-id="{{ order.id }}" data-new-status="완료">완료</button>
                            <button type="button" class="btn btn-sm rounded-0 flex-grow-1 status-btn {{ 'btn-secondary text-white' if order.order_status == '기타' else 'btn-outline-secondary' }}" data-order-id="{{ order.id }}" data-new-status="기타">기타</button>
                        </div>
                    </div>
                </li>
                {% else %}
                <li class="list-group-item text-center text-muted p-5">
                    진행 중인 주문이 없습니다.
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="card rounded-0 border shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-bold"><i class="bi bi-calendar-month me-2"></i>월별 주문 목록</h5>
        </div>
        <div class="card-body p-0">
            <div class="p-3 border-bottom bg-light">
                <form method="GET" action="{{ url_for('ui.order_list') }}" class="row g-2 align-items-center">
                    <div class="col-auto">
                        <select name="year" class="form-select form-select-sm rounded-0">
                            {% for year in year_list %}
                            <option value="{{ year }}" {{ 'selected' if year == selected_year else '' }}>{{ year }}년</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select name="month" class="form-select form-select-sm rounded-0">
                            {% for month in month_list %}
                            <option value="{{ month }}" {{ 'selected' if month == selected_month else '' }}>{{ month }}월</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary btn-sm rounded-0 px-3">
                            <i class="bi bi-search me-1"></i> 조회
                        </button>
                    </div>
                    <div class="col-auto ms-auto">
                        <span class="fw-bold text-primary">{{ monthly_orders|length }}</span>건 조회됨
                    </div>
                </form>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="table-light">
                        <tr>
                            <th>일자</th>
                            <th>고객명</th>
                            <th>상품정보</th>
                            <th>상태</th>
                            <th>연락</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in monthly_orders %}
                        <tr style="cursor: pointer;" onclick="window.location='{{ url_for('ui.order_detail', order_id=order.id) }}';">
                            <td>{{ order.created_at.strftime('%m-%d') }}</td>
                            <td class="fw-bold">{{ order.customer_name }}</td>
                            <td class="text-start ps-4">
                                <div class="fw-bold text-dark">{{ order.product_name }}</div>
                                <div class="text-muted small">{{ order.product_number }} | {{ order.color }}/{{ order.size }}</div>
                            </td>
                            <td>
                                <span class="badge bg-info text-dark rounded-0">{{ order.order_status }}</span>
                            </td>
                            <td onclick="event.stopPropagation();">
                                <div class="btn-group">
                                    <a href="tel:{{ order.customer_phone.replace('-', '') }}" class="btn btn-sm btn-outline-success rounded-0"><i class="bi bi-telephone-fill"></i></a>
                                    <a href="{{ order.sms_link }}" class="btn btn-sm btn-outline-primary rounded-0"><i class="bi bi-chat-dots-fill"></i></a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted p-5">해당 월에 등록된 주문이 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/order_list.js') }}"></script>
{% endblock %}